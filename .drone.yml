kind: pipeline
type: docker
name: default

steps:
#  - name: build-image
#    image: meltwater/drone-cache
#    settings:
#      restore: true
#      bucket: true
#      debug: true
#  - name: build
#    image: golang:1.15-alpine
#    pull: always
#    commands:
#      - apk add --update make git
#      - make drone-cache
#  - name: restore-cache-debug
#    image: meltwater/drone-cache:dev
#    settings:
#      pull: true
#      rebuild: true
#      debug: true
  ## push to gcr
  - name: publish-to-gcr
    image: plugins/gcr
    settings:
      repo: gcr.io/k8s-0529/hello-web
      tags: v1.16
      json_key:
        from_secret: gcr_token
  ## deployment app to gke
  - name: deplyment-to-gke
    image: quay.io/honestbee/drone-kubernetes
    settings:
      kubernetes_server: https://35.194.184.129
      kubernetes_token:
        from_secret: kubernetes_token
      namespace: default
      deployment: hello-web
      repo: gcr.io/k8s-0529/hello-web
      container: hello-web
      tag: v1.16
      when:
        ref: [ refs/heads/develop ]

## 載入 docker config 設定
image_pull_secrets:
  - dockerconfigjson

# 觸發 pipeline 條件
trigger:
  ref:
    include: [ refs/heads/develop, refs/heads/qatest, refs/heads/int, refs/tags/v*, refs/tags/t*, refs/tags/release-v* ]